!function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=16)}([function(e,t){e.exports=require("socket-controllers")},function(e,t){e.exports=require("typedi")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("routing-controllers")},function(e,t){e.exports=require("reflect-metadata")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("figlet")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("open")},function(e,t){e.exports=require("uid")},function(e,t){e.exports=require("ejs")},function(e,t,o){"use strict";o.r(t);o(4);var r,n=o(3),i=o(0),s=o(1),c=o(6),u=o.n(c),a=o(5),p=o.n(a),f=o(7),l=o.n(f),g=o(8),d=o(2),y=function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},v=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},h=function(){function e(){this.logger=Object(d.createLogger)({format:d.format.combine(d.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),Object(d.format)(function(e){return"error"===e.level?Object.assign({},e,{message:e.timestamp+" "+e.stack}):e})(),d.format.printf(function(e){var t=e.timestamp,o=e.level,r=e.message,n=e.meta;return n?t+" "+o+" ["+n.filename+":"+n.line+"]: "+r:t+" "+o+" "+r})),transports:[new d.transports.Console({level:"debug",handleExceptions:!0}),new d.transports.File({filename:"error.log",level:"error"}),new d.transports.File({filename:"system.log"})],exitOnError:!1})}return e.prototype.init=function(){this.logger.info("created LoggerSrv")},e.prototype.write=function(e,t){this.logger.info(e)},e.prototype.alert=function(e,t){void 0===t&&(t=3),this.logger.alert(e)},e.prototype.crit=function(e,t){void 0===t&&(t=3),this.logger.crit(e)},e.prototype.data=function(e,t){void 0===t&&(t=3),this.logger.data(e)},e.prototype.debug=function(e,t){void 0===t&&(t=3),this.logger.debug(e)},e.prototype.error=function(e,t){void 0===t&&(t=3),this.logger.error(e)},e.prototype.help=function(e,t){void 0===t&&(t=3),this.logger.help(e)},e.prototype.input=function(e,t){void 0===t&&(t=3),this.logger.input(e)},e.prototype.info=function(e,t){void 0===t&&(t=3),this.logger.info(e)},e.prototype.log=function(e,t,o){void 0===o&&(o=3),this.logger.log(e,t)},e.prototype.notice=function(e,t){void 0===t&&(t=3),this.logger.notice(e)},e.prototype.sql=function(e,t){void 0===t&&(t=3),this.debug(e,t)},e.prototype.prompt=function(e,t){void 0===t&&(t=3),this.logger.prompt(e)},e.prototype.silly=function(e,t){void 0===t&&(t=3),this.logger.silly(e)},e.prototype.verbose=function(e,t){void 0===t&&(t=3),this.logger.verbose(e)},e.prototype.warn=function(e,t){void 0===t&&(t=3),this.logger.warn(e)},e.prototype.warning=function(e,t){void 0===t&&(t=3),this.logger.warning(e)},e=y([Object(s.Service)(),v("design:paramtypes",[])],e)}(),m=function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},b=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},S=function(){function e(e){this.logger=e,this.sockets={},this.logger.info("created SocketMangerSrv")}return e.prototype.init=function(){return Promise.resolve()},e.prototype.addSocket=function(e){var t=e.id;this.sockets[t]=e,this.logger.info("registerd "+t)},e.prototype.delSocket=function(e){this.logger.info("unregisterd "+e),delete this.sockets[e]},e.prototype.getSocket=function(e){return this.sockets[e]},e.prototype.isExistSocket=function(e){return!!this.sockets[e]},e.prototype.getAll=function(){return this.sockets},e.prototype.emitAll=function(e,t){for(var o in this.sockets){this.sockets[o].emit(e,t)}},e=m([Object(s.Service)(),b("design:paramtypes",[h])],e)}(),O=function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},j=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},R=function(){function e(e){this.logSrv=e,this.userCache={}}return e.prototype.init=function(){this.logSrv.info("created UserService")},e.prototype.addUser=function(e,t){var o=this.getUserIdBySockId(t);return o?(this.logSrv.info("already logined user "+o),!1):this.getSockIdById(e)?(this.logSrv.info("already used user id"),!1):(this.userCache[e]=t,this.logSrv.info("Logined New User : "+e),!0)},e.prototype.removeUser=function(e){this.userCache[e]=null,this.logSrv.info("Logout User : "+e)},e.prototype.getSockIdById=function(e){return this.userCache[e]},e.prototype.getUserIdBySockId=function(e){for(var t in this.userCache)if(e===this.userCache[t])return t;return null},e.prototype.getUsers=function(){return this.userCache},e=O([Object(s.Service)(),j("design:paramtypes",[h])],e)}(),k=function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},U=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},C=function(){function e(e,t){this.loggerService=e,this.userService=t,this.listCache={}}return e.prototype.init=function(){this.loggerService.info("created RoomService")},e.prototype.addRoom=function(e,t,o){var r;this.listCache[e]={name:t,creator:o,users:(r={},r[o]=null,r)}},e.prototype.getRooms=function(e){return e?this.getRoomByUserId(e):this.listCache},e.prototype.getRoomByUserId=function(e){var t;for(var o in this.listCache)for(var r in this.listCache[o].users)r===e&&(t||(t={}),t[o]=this.listCache[o]);return t},e.prototype.getRoom=function(e){for(var t in this.listCache)if(e===t)return this.listCache[t];return null},e.prototype.loginUser=function(e,t){var o=this.getRoom(e),r=this.userService.getSockIdById(t),n=this.getRoomByUserId(t);if(n)for(var i in n)this.logoutUser(i,t);return!(!t||!o)&&(o.users[t]=r,this.loggerService.info("["+o.name+"] Chat room login: "+t),!0)},e.prototype.loginUsers=function(e,t){for(var o=0,r=t;o<r.length;o++){var n=r[o];this.loginUser(e,n)}},e.prototype.addUser=function(e,t){var o=this.getRoom(e);return!!o&&(o.users[t]=null,this.loggerService.info("["+o.name+"] Chat room invited: "+t),!0)},e.prototype.addUsers=function(e,t){for(var o=0,r=t;o<r.length;o++){var n=r[o];this.addUser(e,n)}},e.prototype.logoutUser=function(e,t){var o=this.getRoom(e);return!(!t||!o)&&(o.users[t]=null,this.loggerService.info("["+o.name+"] Chat room logout: "+t),!0)},e.prototype.logoutRoom=function(e){var t=this.getRoomByUserId(e);for(var o in t)this.logoutUser(o,e)},e.prototype.isExistUser=function(e,t){var o=this.getRoom(e);if(o)for(var r in o.users)if(r===t)return!0;return!1},e=k([Object(s.Service)(),U("design:paramtypes",[h,R])],e)}(),w=function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},I=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},M=(function(){function e(e){this.loggerSrv=e,this.loggerSrv.info("created RootController")}e.prototype.helloServer=function(){},w([Object(n.Get)("/"),Object(n.Render)("index.html"),I("design:type",Function),I("design:paramtypes",[]),I("design:returntype",void 0)],e.prototype,"helloServer",null),e=w([Object(n.Controller)(""),I("design:paramtypes",[h])],e)}(),function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s}),x=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},B=function(e,t){return function(o,r){t(o,r,e)}},P=o(14),q=function(){function e(e,t,o,r){this.sockMgrSrv=e,this.userSrv=t,this.roomSrv=o,this.loggerSrv=r,this.loggerSrv.info("created WsMessageController")}return e.prototype.connection=function(e){this.sockMgrSrv.addSocket(e),this.loggerSrv.info("new socket client connected")},e.prototype.disconnect=function(e){var t=e.id,o=this.userSrv.getUserIdBySockId(t);o&&(this.roomSrv.logoutRoom(o),this.userSrv.removeUser(o),this.sockMgrSrv.emitAll("users",this.userSrv.getUsers())),this.sockMgrSrv.delSocket(t)},e.prototype.addUser=function(e,t){var o=t.name,r=this.userSrv.addUser(o,e.id);r&&this.sockMgrSrv.emitAll("users",this.userSrv.getUsers()),e.emit("login",r?o:null),e.emit("room",this.roomSrv.getRooms(o))},e.prototype.removeUser=function(e){var t=e.id,o=this.userSrv.getUserIdBySockId(t);o&&(this.roomSrv.logoutRoom(o),this.userSrv.removeUser(o),this.sockMgrSrv.emitAll("users",this.userSrv.getUsers()),e.emit("logout"))},e.prototype.getRoom=function(e,t){var o=this.userSrv.getUserIdBySockId(e.id);if(o){var r=t?this.roomSrv.getRoom(t.id):this.roomSrv.getRooms(o);e.emit("room",r)}else e.emit("room",null)},e.prototype.addRoom=function(e,t){var o=P(),r=this.userSrv.getUserIdBySockId(e.id);r=r||"Unknown",this.roomSrv.addRoom(o,t.name,r),e.emit("room",this.roomSrv.getRooms(r))},e.prototype.updateRoom=function(e){var t=this.roomSrv.getRoom(e);if(t)for(var o in t.users){var r=t.users[o];r&&this.sockMgrSrv.getSocket(r).emit("room",this.roomSrv.getRooms())}},e.prototype.enterRoom=function(e,t){var o=this.userSrv.getUserIdBySockId(e.id);if(o&&t){var r=t.id;this.roomSrv.loginUser(r,o),this.updateRoom(r),e.emit("room/in",r)}else this.loggerSrv.info("user not found")},e.prototype.leaveRoom=function(e,t){var o=this.userSrv.getUserIdBySockId(e.id);if(o&&t){var r=t.id;this.roomSrv.logoutUser(r,o),this.updateRoom(r),e.emit("room/out",r)}else this.loggerSrv.info("user not found")},e.prototype.roomMessage=function(e,t){var o=t.roomId,r=t.type,n=t.message,i=this.roomSrv.getRoom(o),s=this.userSrv.getUserIdBySockId(e.id);if(i)for(var c in i.users){var u=i.users[c];if(u){var a={type:r,message:n,userId:s||"unknown",isMy:u===e.id,date:new Date};this.sockMgrSrv.getSocket(u).emit("room/message",a)}}},e.prototype.inviteUser=function(e){var t=this.userSrv.getUsers(),o=e.roomId,r=e.users;this.roomSrv.addUsers(o,r);var n=this.roomSrv.getRoom(o);if(n)for(var i in n.users){var s=t[i];s&&this.sockMgrSrv.getSocket(s).emit("room",this.roomSrv.getRooms(i))}},e.prototype.getUsers=function(e){var t=this.userSrv.getUserIdBySockId(e.id)?this.userSrv.getUsers():null;e.emit("users",t)},M([Object(i.OnConnect)(),B(0,Object(i.ConnectedSocket)()),x("design:type",Function),x("design:paramtypes",[Object]),x("design:returntype",void 0)],e.prototype,"connection",null),M([Object(i.OnDisconnect)(),B(0,Object(i.ConnectedSocket)()),x("design:type",Function),x("design:paramtypes",[Object]),x("design:returntype",void 0)],e.prototype,"disconnect",null),M([Object(i.OnMessage)("login"),B(0,Object(i.ConnectedSocket)()),B(1,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object,Object]),x("design:returntype",void 0)],e.prototype,"addUser",null),M([Object(i.OnMessage)("logout"),B(0,Object(i.ConnectedSocket)()),x("design:type",Function),x("design:paramtypes",[Object]),x("design:returntype",void 0)],e.prototype,"removeUser",null),M([Object(i.OnMessage)("room"),B(0,Object(i.ConnectedSocket)()),B(1,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object,Object]),x("design:returntype",void 0)],e.prototype,"getRoom",null),M([Object(i.OnMessage)("room/new"),B(0,Object(i.ConnectedSocket)()),B(1,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object,Object]),x("design:returntype",void 0)],e.prototype,"addRoom",null),M([Object(i.OnMessage)("room/in"),B(0,Object(i.ConnectedSocket)()),B(1,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object,Object]),x("design:returntype",void 0)],e.prototype,"enterRoom",null),M([Object(i.OnMessage)("room/out"),B(0,Object(i.ConnectedSocket)()),B(1,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object,Object]),x("design:returntype",void 0)],e.prototype,"leaveRoom",null),M([Object(i.OnMessage)("room/message"),B(0,Object(i.ConnectedSocket)()),B(1,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object,Object]),x("design:returntype",void 0)],e.prototype,"roomMessage",null),M([Object(i.OnMessage)("room/invite"),B(0,Object(i.MessageBody)()),x("design:type",Function),x("design:paramtypes",[Object]),x("design:returntype",void 0)],e.prototype,"inviteUser",null),M([Object(i.OnMessage)("users"),B(0,Object(i.ConnectedSocket)()),x("design:type",Function),x("design:paramtypes",[Object]),x("design:returntype",void 0)],e.prototype,"getUsers",null),e=M([Object(i.SocketController)("/chat"),x("design:paramtypes",[S,R,C,h])],e)}(),F=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),_=function(e,t,o,r){return new(o||(o=Promise))(function(n,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?n(e.value):new o(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})},D=function(e,t){var o,r,n,i,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,r&&(n=2&i[0]?r.return:i[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,i[1])).done)return n;switch(r=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){s.label=i[1];break}if(6===i[0]&&s.label<n[1]){s.label=n[1],n=i;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(i);break}n[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{o=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},E=o(9),A=o(10),L=o(11),Y=o(12);o(13);new(function(e){function t(t){var r=this,c=Y.join("dist","public");r=e.call(this)||this,Object(n.useContainer)(s.Container),Object(i.useContainer)(s.Container),r.app=p()(),r.app.use(L()),r.app.engine("html",o(15).renderFile),r.app.set("views",Y.join(c)),r.app.set("view engine","html"),Object(n.useExpressServer)(r.app),r.server=u.a.createServer(r.app),r.app.use("/public",p.a.static(c)),r.io=l()(r.server),Object(i.useSocketServer)(r.io,{controllers:[q]});var a=s.Container.get(h);return a.info("\n"+A.textSync("Sample")),r.app.use(E("combined",{stream:a})),r.addServices(),r.port=t?parseInt(t,10):4e3,r}return F(t,e),t.prototype.addMiddleware=function(e){this.app.use(e)},t.prototype.addServices=function(){return _(this,void 0,void 0,function(){var e,t,o,r,n,i,c,u,a,p,f;return D(this,function(l){switch(l.label){case 0:for(e=[{name:"socketIO",instance:this.io}],t=s.Container.get(h),o=0,r=e;o<r.length;o++)i=(n=r[o]).name,p=n.instance,s.Container.set(i,p),t.info("[init] DI Registered "+i);c=0,u=[R,C,S],l.label=1;case 1:if(!(c<u.length))return[3,6];a=u[c],l.label=2;case 2:return l.trys.push([2,4,,5]),[4,(p=s.Container.get(a)).init()];case 3:return l.sent(),t.info("[Serivce Initialize] DI Registered "+a.name),[3,5];case 4:return f=l.sent(),console.log(f.stack),t.error(f),[3,5];case 5:return c++,[3,1];case 6:return this.emit("ready"),[2]}})})},t.prototype.getApp=function(){return this.app},t.prototype.runServ=function(){var e=this,t=s.Container.get(h);return new Promise(function(o){e.once("ready",function(){return _(e,void 0,void 0,function(){var e=this;return D(this,function(r){return o(this.server.listen(this.port,function(){return t.info("listening on port "+e.port)})),[2]})})})})},t}(g.EventEmitter))("4000").runServ()}]);
//# sourceMappingURL=server.bundle.js.map